<main class="global-main card-wrapper">
  <div class="card page-content">
    <div class="top row space-between">
      <app-input-search
        [value]="searchParam"
        (onChange)="onChangeSearchInputHandler($event)"
      ></app-input-search>
      <div class="filter-wrapper">
        <app-filter-btn [target]="'filter_devices'"></app-filter-btn>
      </div>
      <app-add-button
        *ngIf="userRole === 'admin' || userRole === 'super'"
        [title]="'добавить устройство'"
        [target]="'add_device'"
      ></app-add-button>
    </div>
    <app-devices-filters
      [filter]="filter"
      [configs]="configs"
      [groups]="groups"
      (onStatusRemove)="resetOneSearchParam('status')"
      (onDateFromRemove)="resetOneSearchParam('dateFrom')"
      (onDateToRemove)="resetOneSearchParam('dateTo')"
      (onConfigsIDsRemove)="resetOneSearchParam('configsIDs', $event)"
      (onGroupsIDsRemove)="resetOneSearchParam('groupsIDs', $event)"
    ></app-devices-filters>
    <ng-container *ngIf="loading; else dummy">
      <div class="progress">
        <div class="indeterminate"></div>
      </div>
    </ng-container>
    <ng-template #dummy>
      <div class="dummy"></div>
    </ng-template>
    <app-selected-elements
      *ngIf="userRole === 'admin' || userRole === 'super'"
      [selectedIDs]="selectedDevicesIDs"
      [editTarget]="'edit_several_devices'"
      [deleteTarget]="'delete_several_elements'"
      (onCloseClick)="cancelSelection()"
    ></app-selected-elements>
    <div class="list">
      <div class="list-header">
        <div
          class="checkbox-wrapper"
          *ngIf="userRole === 'admin' || userRole === 'super'"
        >
          <app-input-checkbox
            [value]="isAllSelected"
            (onChange)="selectUnselectDevices()"
          ></app-input-checkbox>
        </div>
        <div class="sort-headers row space-between">
          <div class="sort-btn-wrapper status">
            <app-sort-btn
              [title]="'Статус'"
              [isSortAsc]="sortStatusAsc"
              (onCLick)="changeSortStatusDir()"
            ></app-sort-btn>
          </div>
          <div class="sort-btn-wrapper date">
            <app-sort-btn
              [title]="'Дата обн.'"
              [isSortAsc]="sortDateAsc"
              (onCLick)="changeSortDateDir()"
            ></app-sort-btn>
          </div>
          <div class="sort-btn-wrapper name">
            <app-sort-btn
              [title]="'Название'"
              [isSortAsc]="sortNameAsc"
              (onCLick)="changeSortNameDir()"
            ></app-sort-btn>
          </div>
          <p class="descr">Описание</p>
          <p class="phone">Телефон</p>
          <!--          <p>IMEI</p>-->
          <!--          <p>Модель</p>-->
          <p class="phone_imei">Модель / IMEI</p>
          <div class="sort-btn-wrapper group">
            <app-sort-btn
              [title]="'Группа'"
              [isSortAsc]="sortGroupAsc"
              (onCLick)="changeSortGroupDir()"
            ></app-sort-btn>
          </div>
          <p class="conf">Конфигурация</p>
          <p class="update">Обнов-е</p>
          <p class="version">Версия<br />лаунчера</p>
          <div class="sort-btn-wrapper battery">
            <app-sort-btn
              [title]="'Заряд'"
              [isSortAsc]="sortBatteryAsc"
              (onCLick)="changeSortBatteryDir()"
            ></app-sort-btn>
          </div>
          <p class="lock" *ngIf="userRole === 'admin' || userRole === 'super'">
            Блок
          </p>
          <p class="actions">Действия</p>
        </div>
      </div>
      <div class="list-body">
        <ng-container *ngIf="devices.length !== 0; else nodata">
          <app-device-item
            *ngFor="
              let device of devices
                | search: searchParam:'device'
                | devicesFilter
                  : filter.status
                  : filter.dateFrom
                  : filter.dateTo
                  : filter.configsIDs
                  : filter.groupsIDs
                | devices_status: sortStatusAsc
                | devices_date: sortDateAsc
                | devices_group: groups:sortGroupAsc
                | devices_battery: sortBatteryAsc
                | devices_name: sortNameAsc
            "
            [device]="device"
            [groups]="groups"
            [configs]="configs"
            [userRole]="userRole"
            (onSelectUnselectDevice)="selectUnselectDevice($event)"
            (onChangeDeviceState)="changeDeviceState($event)"
            (onClickDeviceQRCode)="getDeviceQRCode($event)"
            (onClickDeviceEdit)="selectDeviceToEdit($event)"
            (onClickDeviceDelete)="selectDeviceToDelete($event)"
            (onClickDeviceReboot)="rebootDevice($event)"
            (onClickDeviceFiles)="getDeviceFiles($event)"
          ></app-device-item>
        </ng-container>
        <ng-template #nodata>
          <app-no-list-data></app-no-list-data>
        </ng-template>
      </div>
    </div>
  </div>
</main>

<app-filter-devices
  [configs]="configs"
  [groups]="groups"
  (onCancel)="resetSearchParams()"
  (onSubmit)="searchDevicesWithParams()"
></app-filter-devices>
<app-add-device
  *ngIf="userRole === 'admin' || userRole === 'super'"
  [groups]="groups"
  [isDataFetching]="loading"
  (onSubmit)="addDevice()"
></app-add-device>
<app-qr-code [device]="currDevice"></app-qr-code>
<app-edit-device
  *ngIf="userRole === 'admin' || userRole === 'super'"
  [groups]="groups"
  [isDataFetching]="loading"
  (onSubmit)="editDevice()"
></app-edit-device>
<app-edit-several-devices
  *ngIf="userRole === 'admin' || userRole === 'super'"
  [groups]="groups"
  [isDataFetching]="loading"
  (onSubmit)="editSeveralDevices()"
></app-edit-several-devices>
<app-delete-device
  *ngIf="userRole === 'admin' || userRole === 'super'"
  [device]="currDevice"
  [isDataFetching]="loading"
  (onSubmit)="deleteDevice($event)"
></app-delete-device>
<app-delete-several-elements
  *ngIf="userRole === 'admin' || userRole === 'super'"
  [isDataFetching]="loading"
  (onSubmit)="deleteSeveralDevices()"
></app-delete-several-elements>
<app-device-files
  *ngIf="userRole === 'admin' || userRole === 'super'"
  [device]="currDevice"
  (onDeleteClick)="selectFileToDelete($event)"
></app-device-files>
<app-delete-file
  *ngIf="userRole === 'admin' || userRole === 'super'"
  [file]="currFile"
  [isDataFetching]="loading"
  (onSubmit)="deleteFile($event)"
></app-delete-file>
